/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","../AjaxDataHandler","../Icons","jquery-ui/droppable"],(function(e,t,a,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{static initialize(){a(s.contentIdentifier).draggable({handle:s.dragHeaderIdentifier,scope:"tt_content",cursor:"move",distance:20,revert:"invalid",zIndex:100,start:e=>{s.onDragStart(a(e.target))},stop:e=>{s.onDragStop(a(e.target))}}),a(s.dropZoneIdentifier).droppable({accept:this.contentIdentifier,scope:"tt_content",tolerance:"pointer",over:(e,t)=>{s.onDropHoverOver(a(t.draggable),a(e.target))},out:(e,t)=>{s.onDropHoverOut(a(t.draggable),a(e.target))},drop:(e,t)=>{s.onDrop(a(t.draggable),a(e.target),e)}})}static onDragStart(e){s.originalStyles=e.get(0).style.cssText,e.children(s.dragIdentifier).addClass("dragitem-shadow"),e.append('<div class="ui-draggable-copy-message">'+TYPO3.lang["dragdrop.copy.message"]+"</div>"),e.children(s.dropZoneIdentifier).addClass("drag-start"),e.closest(s.columnIdentifier).removeClass("active"),e.find(s.dropZoneIdentifier).hide(),a(s.dropZoneIdentifier).each((e,t)=>{const n=a(t);n.parent().find(".t3js-toggle-new-content-element-wizard").length?n.addClass(s.validDropZoneClass):n.closest(s.contentIdentifier).find("> "+s.addContentIdentifier+", > > "+s.addContentIdentifier).show()})}static onDragStop(e){e.children(s.dragIdentifier).removeClass("dragitem-shadow"),e.children(s.dropZoneIdentifier).removeClass("drag-start"),e.closest(s.columnIdentifier).addClass("active"),e.find(s.dropZoneIdentifier).show(),e.find(".ui-draggable-copy-message").remove(),e.get(0).style.cssText=s.originalStyles,a(s.dropZoneIdentifier+"."+s.validDropZoneClass).removeClass(s.validDropZoneClass)}static onDropHoverOver(e,t){t.hasClass(s.validDropZoneClass)&&t.addClass(s.dropPossibleHoverClass)}static onDropHoverOut(e,t){t.removeClass(s.dropPossibleHoverClass)}static onDrop(e,t,n){const r=s.getColumnPositionForElement(t);t.removeClass(s.dropPossibleHoverClass);const i=parseInt(e.data("uid"),10);if("number"==typeof i&&i>0){let d={};const l=t.closest(s.contentIdentifier).data("uid");let c=0;c=void 0===l?parseInt(n.target.offsetParent.getAttribute("data-page"),10):0-parseInt(l,10);const g=parseInt(t.closest("[data-language-uid]").data("language-uid"),10);let p=0;0!==c&&(p=r),d.cmd={tt_content:{}},d.data={tt_content:{}};const f=n&&n.originalEvent.ctrlKey||t.hasClass("t3js-paste-copy");f?d.cmd.tt_content[i]={copy:{action:"paste",target:c,update:{colPos:p,sys_language_uid:g}}}:(d.data.tt_content[i]={colPos:p,sys_language_uid:g},d.cmd.tt_content[i]={move:c}),s.ajaxAction(t,e,d,f).then(()=>{const t=a(`.t3-page-column-lang-name[data-language-uid="${g}"]`);if(0===t.length)return;const n=t.data("flagIdentifier"),s=t.data("languageTitle");e.find(".t3js-language-title").text(s),o.getIcon(n,o.sizes.small).then(t=>{e.find(".t3js-flag").attr("title",s).html(t)})})}}static ajaxAction(e,t,a,o){return n.process(a).then(a=>{if(a.hasErrors)throw a.messages;e.parent().hasClass(s.contentIdentifier.substring(1))?t.detach().css({top:0,left:0}).insertAfter(e.closest(s.contentIdentifier)):t.detach().css({top:0,left:0}).insertAfter(e.closest(s.dropZoneIdentifier)),o&&self.location.reload()})}static getColumnPositionForElement(e){const t=e.closest("[data-colpos]");return!(!t.length||"undefined"===t.data("colpos"))&&t.data("colpos")}}s.contentIdentifier=".t3js-page-ce",s.dragIdentifier=".t3-page-ce-dragitem",s.dragHeaderIdentifier=".t3js-page-ce-draghandle",s.dropZoneIdentifier=".t3js-page-ce-dropzone-available",s.columnIdentifier=".t3js-page-column",s.validDropZoneClass="active",s.dropPossibleHoverClass="t3-page-ce-dropzone-possible",s.addContentIdentifier=".t3js-page-new-ce",s.originalStyles="",t.default=s,a(s.initialize)}));